using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Outlook = Microsoft.Office.Interop.Outlook;

/* Uses current outlook session to grab email attachments and write to Documents\Poetfiles\ folder where 
 * subject contains 'CSV analysis file for Pre Alert#'
 * Andrew Borst 9/12/2017           */
namespace EmailGrabber
{
    class Program
    {
        static void Main(string[] args)
        {
            Outlook.Application application = new Outlook.Application();
            Outlook.NameSpace ns = application.GetNamespace("Mapi");

            Outlook.MAPIFolder inboxFolder = ns.GetDefaultFolder(Outlook.OlDefaultFolders.olFolderInbox);
            string sFilter = "@SQL=" + "\"" + "urn:schemas:httpmail:subject" + "\"" + " like '%CSV analysis file for Pre Alert#%'"; 

            Outlook.Items mailItems = inboxFolder.Items.Restrict(sFilter);

            String path = Environment.GetFolderPath(Environment.SpecialFolder.UserProfile) + "\\Documents\\PoetFiles\\";

            System.IO.Directory.CreateDirectory(path);

            foreach (Outlook.MailItem item in mailItems)
            {
                System.Diagnostics.Trace.WriteLine(item.Subject);
                System.Diagnostics.Trace.WriteLine(path);
                item.Attachments[1].SaveAsFile(path + item.Attachments[1].FileName);

            }
        }
    }
}
